import React, { useMemo } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Area, AreaChart, ResponsiveContainer } from 'recharts';

export const ForgettingCurve = ({
  lastReviewDate,
  currentMemoryRate = 28,
  nextReviewDate
}) => {
  // 에빙하우스 망각곡선 데이터 생성
  const curveData = useMemo(() => {
    const data = [];
    const days = 30;

    for (let i = 0; i <= days; i++) {
      let retention;
      if (i === 0) {
        retention = 100;
      } else if (i === 1) {
        retention = 58;
      } else if (i === 2) {
        retention = 44;
      } else if (i === 7) {
        retention = 33;
      } else if (i === 14) {
        retention = 28;
      } else if (i === 30) {
        retention = 21;
      } else {
        // 보간법으로 중간값 계산
        retention = 100 * Math.exp(-i / 5);
      }

      data.push({
        day: i,
        retention: Math.max(retention, 20),
        label: i === 0 ? '학습' : i === 1 ? '1일' : i === 7 ? '1주' : i === 30 ? '1개월' : ''
      });
    }

    return data;
  }, []);

  // 현재 날짜 계산
  const daysSinceReview = lastReviewDate
    ? Math.floor((new Date() - new Date(lastReviewDate)) / (1000 * 60 * 60 * 24))
    : 0;

  return (
    <div className="bg-white rounded-2xl p-6 shadow-lg">
      {/* 헤더 */}
      <div className="mb-6">
        <h3 className="text-xl font-bold text-[#111111] mb-2">
          에빙하우스 망각곡선
        </h3>
        <p className="text-sm text-[#767676]">
          마지막 복습: {lastReviewDate ? new Date(lastReviewDate).toLocaleDateString('ko-KR') : '없음'}
        </p>
      </div>

      {/* 그래프 */}
      <div className="relative">
        <ResponsiveContainer width="100%" height={200}>
          <AreaChart data={curveData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
            <defs>
              <linearGradient id="memoryGradient" x1="0" y1="0" x2="0" y2="1">
                <stop offset="5%" stopColor="#00c288" stopOpacity={0.3}/>
                <stop offset="95%" stopColor="#00c288" stopOpacity={0.05}/>
              </linearGradient>
            </defs>
            <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
            <XAxis
              dataKey="day"
              tick={{ fontSize: 12, fill: '#767676' }}
              tickFormatter={(value) => {
                if (value === 0) return '0일';
                if (value === 1) return '1일';
                if (value === 7) return '1주';
                if (value === 14) return '2주';
                if (value === 30) return '1개월';
                return '';
              }}
            />
            <YAxis
              tick={{ fontSize: 12, fill: '#767676' }}
              domain={[0, 100]}
              tickFormatter={(value) => `${value}%`}
            />
            <Tooltip
              formatter={(value) => `${Math.round(value)}%`}
              labelFormatter={(label) => `${label}일 후`}
              contentStyle={{
                backgroundColor: '#fff',
                border: '1px solid #e0e0e0',
                borderRadius: '8px',
                fontSize: '12px'
              }}
            />
            <Area
              type="monotone"
              dataKey="retention"
              stroke="#00c288"
              strokeWidth={2}
              fill="url(#memoryGradient)"
            />
            <Line
              type="monotone"
              dataKey="retention"
              stroke="#00c288"
              strokeWidth={2}
              dot={false}
            />
          </AreaChart>
        </ResponsiveContainer>

        {/* 현재 위치 마커 */}
        {daysSinceReview > 0 && daysSinceReview <= 30 && (
          <div
            className="absolute top-[40px] bg-[#111111] text-white px-3 py-1 rounded-lg text-xs font-medium"
            style={{
              left: `${(daysSinceReview / 30) * 85 + 7}%`,
              transform: 'translateX(-50%)'
            }}
          >
            {currentMemoryRate}%
            <div className="absolute bottom-[-4px] left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[4px] border-t-[#111111]"></div>
          </div>
        )}
      </div>

      {/* 경고 메시지 */}
      <div className="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-xl">
        <div className="flex items-start gap-3">
          <div className="w-10 h-10 flex items-center justify-center bg-amber-200 rounded-full flex-shrink-0">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
              <path d="M2 17L12 22L22 17" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
              <path d="M2 12L12 17L22 12" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
          </div>
          <div>
            <p className="font-semibold text-[#111111] mb-1">
              복습이 필요합니다
            </p>
            <p className="text-sm text-[#767676] mb-2">
              현재 {currentMemoryRate}% 망각되었습니다
            </p>
            <p className="text-xs text-[#999999]">
              기억이 희미해지기 전에 복습하면 더 오래 기억할 수 있습니다
            </p>
          </div>
        </div>
      </div>

      {/* 액션 버튼들 */}
      <div className="flex gap-3 mt-4">
        <button className="flex-1 py-3 bg-[#f1f3f5] rounded-xl font-medium text-[#767676] hover:bg-[#e8eaec] transition-colors">
          나중에 복습하기
        </button>
        <button className="flex-1 py-3 bg-gradient-to-r from-[#00c288] to-[#00a876] text-white rounded-xl font-semibold hover:shadow-lg transition-all">
          지금 복습 시작
        </button>
      </div>
    </div>
  );
};