import React, { useState, useEffect } from 'react';

export const ReviewMode = ({
  documentContent,
  documentTitle,
  onComplete,
  onExit
}) => {
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [questions, setQuestions] = useState([]);
  const [answers, setAnswers] = useState([]);
  const [currentAnswer, setCurrentAnswer] = useState('');
  const [showFeedback, setShowFeedback] = useState(false);
  const [isCorrect, setIsCorrect] = useState(false);
  const [score, setScore] = useState(0);
  const [startTime, setStartTime] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [showResults, setShowResults] = useState(false);

  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ë¬¸ì œ ìƒì„±
  useEffect(() => {
    generateQuestions();
    setStartTime(new Date());
  }, [documentContent]);

  // AIë¡œ ë¬¸ì œ ìƒì„± (ì„ì‹œë¡œ í•˜ë“œì½”ë”©)
  const generateQuestions = async () => {
    setIsLoading(true);

    // TODO: ì‹¤ì œë¡œëŠ” AI API í˜¸ì¶œ
    // const response = await generateQuizFromDocument(documentContent);

    // ì„ì‹œ ë¬¸ì œ ë°ì´í„°
    const mockQuestions = [
      {
        type: 'fill-blank',
        question: 'ì—ë¹™í•˜ìš°ìŠ¤ì˜ ___ì— ë”°ë¥´ë©´ í•™ìŠµ í›„ 24ì‹œê°„ì´ ì§€ë‚˜ë©´ ___% ì •ë„ë¥¼ ìŠì–´ë²„ë¦°ë‹¤.',
        blanks: ['ë§ê°ê³¡ì„ ', '70'],
        hint: 'ê¸°ì–µê³¼ ê´€ë ¨ëœ ì´ë¡ ì…ë‹ˆë‹¤'
      },
      {
        type: 'multiple-choice',
        question: 'ë‹¤ìŒ ì¤‘ íš¨ê³¼ì ì¸ ë³µìŠµ ì£¼ê¸°ë¡œ ê°€ì¥ ì ì ˆí•œ ê²ƒì€?',
        options: [
          'ë§¤ì¼ ë³µìŠµ',
          '1ì¼, 3ì¼, 7ì¼, 30ì¼ ê°„ê²©',
          'ì¼ì£¼ì¼ì— í•œ ë²ˆ',
          'ì‹œí—˜ ì „ë‚  ëª°ì•„ì„œ'
        ],
        correctAnswer: 1,
        explanation: 'ë§ê°ê³¡ì„ ì„ ê³ ë ¤í•œ ê°„ê²© ë°˜ë³µ í•™ìŠµì´ ê°€ì¥ íš¨ê³¼ì ì…ë‹ˆë‹¤.'
      },
      {
        type: 'short-answer',
        question: 'ì¥ê¸°ê¸°ì–µìœ¼ë¡œ ì „í™˜í•˜ê¸° ìœ„í•œ ê°€ì¥ ì¤‘ìš”í•œ ë°©ë²•ì€ ë¬´ì—‡ì¸ê°€ìš”?',
        keywords: ['ë°˜ë³µ', 'ë³µìŠµ', 'ê°„ê²©'],
        explanation: 'ì¼ì •í•œ ê°„ê²©ì„ ë‘ê³  ë°˜ë³µ í•™ìŠµí•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.'
      }
    ];

    setQuestions(mockQuestions);
    setIsLoading(false);
  };

  // ë‹µë³€ í™•ì¸
  const checkAnswer = () => {
    const question = questions[currentQuestionIndex];
    let correct = false;

    switch (question.type) {
      case 'fill-blank':
        // ë¹ˆì¹¸ ì±„ìš°ê¸° - ëª¨ë“  ë¹ˆì¹¸ì´ ë§ì•„ì•¼ ì •ë‹µ
        const userAnswers = currentAnswer.split(',').map(a => a.trim().toLowerCase());
        const correctAnswers = question.blanks.map(a => a.toLowerCase());
        correct = JSON.stringify(userAnswers) === JSON.stringify(correctAnswers);
        break;

      case 'multiple-choice':
        // ê°ê´€ì‹
        correct = parseInt(currentAnswer) === question.correctAnswer;
        break;

      case 'short-answer':
        // ì£¼ê´€ì‹ - í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€ í™•ì¸
        const lowerAnswer = currentAnswer.toLowerCase();
        correct = question.keywords.some(keyword =>
          lowerAnswer.includes(keyword.toLowerCase())
        );
        break;
    }

    setIsCorrect(correct);
    setShowFeedback(true);

    if (correct) {
      setScore(score + 1);
    }

    // ë‹µë³€ ê¸°ë¡
    setAnswers([...answers, {
      questionIndex: currentQuestionIndex,
      userAnswer: currentAnswer,
      isCorrect: correct
    }]);
  };

  // ë‹¤ìŒ ë¬¸ì œë¡œ
  const nextQuestion = () => {
    if (currentQuestionIndex < questions.length - 1) {
      setCurrentQuestionIndex(currentQuestionIndex + 1);
      setCurrentAnswer('');
      setShowFeedback(false);
      setIsCorrect(false);
    } else {
      // ë³µìŠµ ì™„ë£Œ
      finishReview();
    }
  };

  // ë³µìŠµ ì™„ë£Œ
  const finishReview = () => {
    const endTime = new Date();
    const duration = Math.round((endTime - startTime) / 1000); // ì´ˆ ë‹¨ìœ„
    const scorePercent = Math.round((score / questions.length) * 100);

    setShowResults(true);

    // ê²°ê³¼ ì½œë°± í˜¸ì¶œ
    if (onComplete) {
      onComplete({
        score: scorePercent,
        duration: duration,
        totalQuestions: questions.length,
        correctAnswers: score,
        answers: answers
      });
    }
  };

  // ë¡œë”© ì¤‘
  if (isLoading) {
    return (
      <div className="flex flex-col items-center justify-center h-96">
        <div className="w-16 h-16 border-4 border-[#00c288] border-t-transparent rounded-full animate-spin mb-4"></div>
        <p className="text-lg font-medium text-[#767676]">AIê°€ ë³µìŠµ ë¬¸ì œë¥¼ ìƒì„±í•˜ê³  ìˆì–´ìš”...</p>
      </div>
    );
  }

  // ê²°ê³¼ í™”ë©´
  if (showResults) {
    const scorePercent = Math.round((score / questions.length) * 100);
    const duration = Math.round((new Date() - startTime) / 1000);

    return (
      <div className="bg-white rounded-2xl p-12 text-center max-w-2xl mx-auto">
        {/* ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜ */}
        <div className="mb-8">
          {scorePercent >= 80 ? (
            <div className="text-8xl animate-bounce">ğŸ‰</div>
          ) : scorePercent >= 60 ? (
            <div className="text-8xl">ğŸ˜Š</div>
          ) : (
            <div className="text-8xl">ğŸ’ª</div>
          )}
        </div>

        <h2 className="text-3xl font-bold mb-2">ë³µìŠµ ì™„ë£Œ!</h2>
        <p className="text-[#767676] mb-8">ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤</p>

        {/* ì ìˆ˜ ë° í†µê³„ */}
        <div className="grid grid-cols-3 gap-6 mb-8">
          <div className={`rounded-xl p-6 ${
            scorePercent >= 80 ? 'bg-green-50' : scorePercent >= 60 ? 'bg-blue-50' : 'bg-orange-50'
          }`}>
            <div className={`text-4xl font-bold mb-2 ${
              scorePercent >= 80 ? 'text-green-600' : scorePercent >= 60 ? 'text-blue-600' : 'text-orange-600'
            }`}>
              {scorePercent}%
            </div>
            <div className="text-sm text-[#767676]">ì •ë‹µë¥ </div>
          </div>
          <div className="bg-[#e8f5e9] rounded-xl p-6">
            <div className="text-4xl font-bold text-[#00c288] mb-2">
              {score}/{questions.length}
            </div>
            <div className="text-sm text-[#767676]">ë§íŒ ë¬¸ì œ</div>
          </div>
          <div className="bg-[#fff3e0] rounded-xl p-6">
            <div className="text-4xl font-bold text-[#ff9800] mb-2">
              {Math.floor(duration / 60)}ë¶„
            </div>
            <div className="text-sm text-[#767676]">ì†Œìš” ì‹œê°„</div>
          </div>
        </div>

        {/* ë‹¤ìŒ ë³µìŠµ ì¼ì • */}
        <div className="bg-gradient-to-r from-[#667eea] to-[#764ba2] rounded-xl p-6 text-white mb-6">
          <p className="text-sm opacity-90 mb-2">ë‹¤ìŒ ë³µìŠµ ì˜ˆì •ì¼</p>
          <p className="text-2xl font-bold mb-2">
            {new Date(Date.now() + (scorePercent >= 80 ? 7 : 3) * 24 * 60 * 60 * 1000).toLocaleDateString('ko-KR')}
          </p>
          <p className="text-sm opacity-90">
            {scorePercent >= 80
              ? 'í›Œë¥­í•´ìš”! 7ì¼ í›„ì— ë‹¤ì‹œ ë³µìŠµí•´ì£¼ì„¸ìš”'
              : '3ì¼ í›„ì— ë‹¤ì‹œ ë³µìŠµí•˜ë©´ ë” ì˜ ê¸°ì–µí•  ìˆ˜ ìˆì–´ìš”'}
          </p>
        </div>

        {/* ì•¡ì…˜ ë²„íŠ¼ */}
        <div className="flex gap-3">
          <button
            onClick={onExit}
            className="flex-1 py-3 bg-[#e0e0e0] rounded-xl font-semibold hover:bg-[#d0d0d0] transition-colors"
          >
            ëŒì•„ê°€ê¸°
          </button>
          {score < questions.length && (
            <button
              onClick={() => {
                setCurrentQuestionIndex(0);
                setScore(0);
                setAnswers([]);
                setShowResults(false);
                setCurrentAnswer('');
                setShowFeedback(false);
              }}
              className="flex-1 py-3 bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white rounded-xl font-semibold hover:shadow-lg transition-all"
            >
              í‹€ë¦° ë¬¸ì œ ë‹¤ì‹œ í’€ê¸°
            </button>
          )}
        </div>
      </div>
    );
  }

  const currentQuestion = questions[currentQuestionIndex];
  const progress = ((currentQuestionIndex + 1) / questions.length) * 100;

  return (
    <div className="max-w-3xl mx-auto">
      {/* ì§„í–‰ í‘œì‹œ */}
      <div className="mb-8">
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm font-medium text-[#767676]">
            ë¬¸ì œ {currentQuestionIndex + 1} / {questions.length}
          </span>
          <span className="text-sm font-medium text-[#00c288]">
            {score}ì 
          </span>
        </div>
        <div className="w-full h-2 bg-[#f0f0f0] rounded-full overflow-hidden">
          <div
            className="h-full bg-gradient-to-r from-[#00c288] to-[#00a876] transition-all duration-300"
            style={{ width: `${progress}%` }}
          />
        </div>
      </div>

      {/* ë¬¸ì œ ì¹´ë“œ */}
      <div className="bg-white rounded-2xl p-8 shadow-lg mb-6">
        <h3 className="text-xl font-semibold mb-6">
          {currentQuestion.type === 'fill-blank' && 'ë¹ˆì¹¸ì„ ì±„ì›Œì£¼ì„¸ìš”'}
          {currentQuestion.type === 'multiple-choice' && 'ì •ë‹µì„ ì„ íƒí•˜ì„¸ìš”'}
          {currentQuestion.type === 'short-answer' && 'ê°„ë‹¨íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”'}
        </h3>

        {/* ë¬¸ì œ ë‚´ìš© */}
        <div className="mb-6">
          {currentQuestion.type === 'fill-blank' && (
            <div>
              <p className="text-lg leading-relaxed mb-4">{currentQuestion.question}</p>
              <input
                type="text"
                value={currentAnswer}
                onChange={(e) => setCurrentAnswer(e.target.value)}
                placeholder="ë‹µì„ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë‹µ1, ë‹µ2)"
                className="w-full px-4 py-3 border-2 border-[#e0e0e0] rounded-xl focus:border-[#00c288] focus:outline-none"
                disabled={showFeedback}
              />
              {currentQuestion.hint && !showFeedback && (
                <p className="text-sm text-[#767676] mt-2">ğŸ’¡ íŒíŠ¸: {currentQuestion.hint}</p>
              )}
            </div>
          )}

          {currentQuestion.type === 'multiple-choice' && (
            <div>
              <p className="text-lg leading-relaxed mb-6">{currentQuestion.question}</p>
              <div className="space-y-3">
                {currentQuestion.options.map((option, idx) => (
                  <button
                    key={idx}
                    onClick={() => !showFeedback && setCurrentAnswer(idx.toString())}
                    className={`w-full p-4 rounded-xl text-left border-2 transition-all ${
                      currentAnswer === idx.toString()
                        ? 'border-[#00c288] bg-[#e8f5e9]'
                        : 'border-[#e0e0e0] hover:border-[#b0b0b0]'
                    } ${showFeedback && idx === currentQuestion.correctAnswer ? 'border-green-500 bg-green-50' : ''}
                    ${showFeedback && currentAnswer === idx.toString() && idx !== currentQuestion.correctAnswer ? 'border-red-500 bg-red-50' : ''}`}
                    disabled={showFeedback}
                  >
                    <span className="font-medium">{String.fromCharCode(65 + idx)}.</span> {option}
                  </button>
                ))}
              </div>
            </div>
          )}

          {currentQuestion.type === 'short-answer' && (
            <div>
              <p className="text-lg leading-relaxed mb-6">{currentQuestion.question}</p>
              <textarea
                value={currentAnswer}
                onChange={(e) => setCurrentAnswer(e.target.value)}
                placeholder="í•µì‹¬ ê°œë…ì„ í¬í•¨í•˜ì—¬ ì„¤ëª…í•´ì£¼ì„¸ìš”..."
                className="w-full h-32 px-4 py-3 border-2 border-[#e0e0e0] rounded-xl focus:border-[#00c288] focus:outline-none resize-none"
                disabled={showFeedback}
              />
            </div>
          )}
        </div>

        {/* í”¼ë“œë°± */}
        {showFeedback && (
          <div className={`p-4 rounded-xl mb-6 ${
            isCorrect ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'
          }`}>
            <div className="flex items-start gap-3">
              <span className="text-2xl">{isCorrect ? 'âœ…' : 'âŒ'}</span>
              <div>
                <p className="font-semibold mb-1">
                  {isCorrect ? 'ì •ë‹µì…ë‹ˆë‹¤!' : 'í‹€ë ¸ìŠµë‹ˆë‹¤'}
                </p>
                {currentQuestion.explanation && (
                  <p className="text-sm text-[#767676]">{currentQuestion.explanation}</p>
                )}
                {!isCorrect && currentQuestion.type === 'fill-blank' && (
                  <p className="text-sm mt-2">
                    ì •ë‹µ: {currentQuestion.blanks.join(', ')}
                  </p>
                )}
              </div>
            </div>
          </div>
        )}

        {/* ì•¡ì…˜ ë²„íŠ¼ */}
        <div className="flex gap-3">
          {!showFeedback ? (
            <>
              <button
                onClick={() => setCurrentAnswer('')}
                className="flex-1 py-3 bg-[#e0e0e0] rounded-xl font-medium hover:bg-[#d0d0d0] transition-colors"
              >
                ê±´ë„ˆë›°ê¸°
              </button>
              <button
                onClick={checkAnswer}
                disabled={!currentAnswer}
                className={`flex-1 py-3 rounded-xl font-semibold transition-all ${
                  currentAnswer
                    ? 'bg-gradient-to-r from-[#00c288] to-[#00a876] text-white hover:shadow-lg'
                    : 'bg-[#e0e0e0] text-[#999999] cursor-not-allowed'
                }`}
              >
                í™•ì¸
              </button>
            </>
          ) : (
            <button
              onClick={nextQuestion}
              className="w-full py-3 bg-gradient-to-r from-[#00c288] to-[#00a876] text-white rounded-xl font-semibold hover:shadow-lg transition-all"
            >
              {currentQuestionIndex < questions.length - 1 ? 'ë‹¤ìŒ ë¬¸ì œ' : 'ê²°ê³¼ ë³´ê¸°'}
            </button>
          )}
        </div>
      </div>

      {/* ë‚˜ê°€ê¸° ë²„íŠ¼ */}
      <button
        onClick={onExit}
        className="text-[#767676] hover:text-[#111111] transition-colors"
      >
        â† ë³µìŠµ ì¤‘ë‹¨í•˜ê³  ëŒì•„ê°€ê¸°
      </button>
    </div>
  );
};